<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Weather Dashboard</title>

<style>
body {
  font-family: Arial;
  background:#0f172a;
  color:white;
  text-align:center;
}

.card {
  background:#1e293b;
  padding:20px;
  margin:15px;
  border-radius:12px;
  display:inline-block;
  width:260px;
}

table {
  margin:20px auto;
  border-collapse: collapse;
  width:90%;
  background:#1e293b;
}

th, td {
  border:1px solid #334155;
  padding:8px;
}

th {
  background:#334155;
}

button {
  padding:10px 18px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-size:14px;
}
</style>
</head>

<body>

<h1>ğŸŒ¦ Weather Stations</h1>

<select id="dev">
  <option value="max1">max1</option>
  <option value="max2">max2</option>
  <option value="max3">max3</option>
  <option value="max4">max4</option>
</select>

<br><br>

ğŸ“… Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙŠÙ:
<input type="date" id="archDate">

<button onclick="loadArchive()">Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
<button onclick="backToCurrent()" id="backBtn" style="display:none">
Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
</button>

<div id="out"></div>

<script>

async function loadCurrent() {

  backBtn.style.display = "none";
  archDate.value = "";

  const dev = devSel();
  const r = await fetch("/api/sensor?device=" + dev);
  const data = await r.json();

  if (!data.today && !data.yesterday) {
    out.innerHTML = "No data";
    return;
  }

  let html = "";

  if (data.today.length > 0) {
    const d = data.today.at(-1);
    html += card("Today", d, d.time);
  }

  if (data.yesterday.length > 0) {
    const d = data.yesterday.at(-1);
    html += card("Yesterday", d, d.reading_date);
  }

  out.innerHTML = html;
}

function card(title, d, t) {
  return `
  <h2>${title}</h2>
  <div class="card">
    ğŸŒ¡ ${d.temperture.toFixed(1)} Â°C<br>
    ğŸ’§ ${d.humidity.toFixed(1)} %<br>
    â² ${d.pressure.toFixed(1)} hPa<br>
    ğŸ’¨ ${d.winds ?? 0} m/s<br>
    ğŸ§­ ${d.windd}<br>
    ğŸ•’ ${new Date(t).toLocaleString()}
  </div>`;
}

async function loadArchive() {

  const date = archDate.value;
  if (!date) {
    alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const dev = devSel();

  const r = await fetch(`/api/sensor?device=${dev}&date=${date}`);
  const rows = await r.json();

  if (!rows || rows.length === 0) {
    out.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®";
    return;
  }

  backBtn.style.display = "inline-block";

  let html = `<h2>Archive â€” ${date}</h2>`;
  html += `<table>
  <tr>
    <th>#</th>
    <th>Temp</th>
    <th>Humidity</th>
    <th>Pressure</th>
    <th>Wind Speed</th>
    <th>Direction</th>
  </tr>`;

  rows.forEach((r, i) => {
    html += `
    <tr>
      <td>${i+1}</td>
      <td>${Number(r.temperture).toFixed(1)}</td>
      <td>${Number(r.humidity).toFixed(1)}</td>
      <td>${Number(r.pressure).toFixed(1)}</td>
      <td>${r.winds ?? 0}</td>
      <td>${r.windd}</td>
    </tr>`;
  });

  html += "</table>";

  out.innerHTML = html;
}

function backToCurrent() {
  loadCurrent();
}

function devSel() {
  return document.getElementById("dev").value;
}

dev.onchange = loadCurrent;

loadCurrent();
setInterval(() => {
  if (backBtn.style.display === "none") loadCurrent();
}, 5000);

</script>

</body>
</html>
